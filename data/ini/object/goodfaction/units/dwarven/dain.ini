;//------------------------------------------------------------------------------
;//
;//	Dain.ini
;// 
;//------------------------------------------------------------------------------
;// aka Dain, Dwarf
Object DwarvenDain
	;// *** ART Parameters ***

    ;//SelectPortrait for Heros is portrait behind skill buttons. HP = HeroPortrait.
	SelectPortrait = HPKingDain

    
    ;// ButtonImage for Heros is button image on Hero Select UI to select hero. HI = HeroIcon or HeroImage.
	ButtonImage = HIKingDain
	
	DescriptionStrategic = CONTROLBAR:LW_ToolTip_Dain

	Scale = 1.05

	;ShadowMaxHeight = 999 ;this is causing 2 shadows to be cast when the unit is under a bridge.  Taking it out!
	Draw = W3DScriptedModelDraw ModuleTag_01

		OkToChangeModelColor	= Yes
		StaticModelLODMode		= Yes ;// Will append M or L to the skin name depending on GameLOD

		;;//====================== MODELS ==================================
		DefaultModelConditionState
			Model               = DUDain2h_SKN
			Skeleton            = DUGloin_SKL
			WeaponLaunchBone    = TERTIARY AXE02
		End

		ModelConditionState = WEAPONSET_TOGGLE_1
			Model               = DUDain2h_SKN
			Skeleton            = DUGloin_SKL
			ParticleSysBone		= BAT_HEAD Slayer FollowBone:Yes
		End

		;RandomTexture 	= dudainmth.tga 0 dudain.tga
		

;;================== ANIMATIONS =================================================================

;;------------------ MOVING & DYING ---------------------------

	;;======= DYING

		AnimationState        = STUNNED_FLAILING
			Animation           = FLYA
				AnimationName     = DUGloin_FLYA
				AnimationMode     = LOOP
				AnimationSpeedFactorRange	= 0.3	0.5
			End
			Flags               = RANDOMSTART
			BeginScript
				Prev = CurDrawablePrevAnimationState()
				if Prev == "DwarfToss" then CurDrawableSetTransitionAnimState("TRANS_EndDwarfToss") end
			EndScript
		End
		
		AnimationState        = DYING SPLATTED
			Animation           = LNDB
				AnimationName     = DUGloin_LNDA
				AnimationMode     = ONCE
			End
			BeginScript
				Prev = CurDrawablePrevAnimationState()
				if Prev == "DwarfToss" then CurDrawableSetTransitionAnimState("TRANS_EndDwarfToss") end
			EndScript
		End

		AnimationState        = DYING
			Animation           = DIEA
				AnimationName     = DUGloin_DTHA
				AnimationMode     = ONCE
			End
		End
		
		AnimationState        = STUNNED_STANDING_UP
			Animation           = GTPA
				AnimationName     = DUGloin_GTPA
				AnimationMode     = ONCE
			End
		End
	
		AnimationState        = STUNNED
			Animation           = LNDA
				AnimationName     = DUGloin_LNDA
				AnimationMode     = ONCE
			End
		End

		AnimationState						= PARALYZED
			Animation
				AnimationName				= DUGloin_IDLA
				AnimationMode				= LOOP
			End
		End

		// SLAM
		AnimationState        = SPECIAL_WEAPON_ONE
			Animation
				AnimationName     = DUGloin_ATKC
				AnimationMode     = ONCE
			End
			ParticleSysBone = NONE GloinBlastSlam	FollowBone:Yes 
		End

		// SHAKE FOUNDATION
		AnimationState        = SPECIAL_WEAPON_TWO
			Animation
				AnimationName     = DUGloin_SPCB
				AnimationMode     = ONCE
			End
		End

		// SHATTERHAMMER 
		AnimationState        = SPECIAL_WEAPON_THREE
			Animation
				AnimationName     = DUGloin_SPCA
				AnimationMode     = ONCE
			End
		End

	;;======= MOVING
	
	
;		AnimationState        = MOVING FIRING_OR_PREATTACK_A
;			ShareAnimation		= Yes
;			Animation           = RunAndFire
;				AnimationName       = DUGloin_ATRA
;				AnimationMode       = LOOP
;			End
;			Flags               = RANDOMSTART
;		End

		AnimationState				=	MOVING ATTACKING
			Animation				=	RUNB
				AnimationName		=	DUGloin_RUNB
				AnimationMode		=	LOOP
			End
			Flags					=	RANDOMSTART
		End
	
		AnimationState				=	MOVING
			Animation				=	RUNA
				AnimationName		=	DUGloin_RUNA
				AnimationMode		=	LOOP
			End
			Flags					=	RANDOMSTART
		End


;;------------------ ATTACKING  -------------------------------

		AnimationState        =  FIRING_OR_PREATTACK_A
			Animation           = ATKA
				AnimationName     = DUGloin_ATKA
				AnimationMode     = ONCE
				UseWeaponTiming		= Yes
			End
			Animation           = ATKB
				AnimationName     = DUGloin_ATKB
				AnimationMode     = ONCE
				UseWeaponTiming		= Yes
			End		
			
			;ParticleSysBone None MeleeDust
			BeginScript
				Prev = CurDrawablePrevAnimationState()
				if Prev == "DwarfToss" then CurDrawableSetTransitionAnimState("TRANS_EndDwarfToss") end
			EndScript
		End

;;-------------------- HIT REACTIONS --------------------------

		AnimationState = HIT_REACTION
			Animation = Hit_Level_1_a
				AnimationName = DUGloin_HITA
				AnimationMode = ONCE
			End
		End
		
;;------------ EMOTIONS ---------------------------------------

;;====== LEVELED
		AnimationState				= LEVELED 						; This state clears itself in 3 seconds
			Animation				= LevelUp
				AnimationName		= DUGloin_LVLA
				AnimationMode		= ONCE
			End
		End

;;====== CELEBRATING
		AnimationState			= EMOTION_CELEBRATING
			Animation           = CHRA
				AnimationName   = DUGloin_CHRA
				AnimationMode   = ONCE
			End
			Flags					=	RESTART_ANIM_WHEN_COMPLETE
		End

;;====== TAUNTING
		AnimationState			= EMOTION_TAUNTING
			Animation
				AnimationName   = DUGloin_TNTA
				AnimationMode   = ONCE
			End
			Flags					=	RESTART_ANIM_WHEN_COMPLETE
		End

		
		AnimationState					= EMOTION_ALERT
			Animation					= Ready
				AnimationName			= DUGloin_IDLA
				AnimationMode			= LOOP
				AnimationBlendTime  =   15
			End
		End
		
		AnimationState			= RAISING_FLAG
			Animation           = CHRA
				AnimationName   = DUGloin_CHRA
				AnimationMode   = LOOP
			End
		End

;;------------------- SELECTED STATES -------------------------
		
		AnimationState				=	SELECTED
			StateName				=	AtAttentionIdle
			SimilarRestart			=   Yes			
			Animation				=	ATNB
				AnimationName		=	 DUGloin_ATNB
				AnimationMode		=	LOOP
			End
			BeginScript
				Prev = CurDrawablePrevAnimationState()
				if Prev == "STATE_Idle" then CurDrawableSetTransitionAnimState("TRANS_Select") end
				if Prev == "AtAttentionIdle" then CurDrawableSetTransitionAnimState("TRANS_Select") end
			EndScript
		End
							
;;--------------- IDLE STATES ---------------------------------

		IdleAnimationState
			StateName				= STATE_Idle
			Animation
				AnimationName     = DUGloin_IDLB
				AnimationMode     = ONCE
				AnimationPriority = 30
			End
			Animation
				AnimationName     = DUGloin_IDLD
				AnimationMode     = ONCE
				AnimationPriority = 4
			End
			Animation
				AnimationName     = DUGloin_IDLC
				AnimationMode     = ONCE
				AnimationPriority = 2
			End
			Animation
				AnimationName     = DUGloin_IDLE
				AnimationMode     = ONCE
				AnimationPriority = 1
			End
			BeginScript
				Prev = CurDrawablePrevAnimationState()
				if Prev == "DwarfToss" then CurDrawableSetTransitionAnimState("TRANS_EndDwarfToss") end
				if Prev == "AtAttentionIdle" then CurDrawableSetTransitionAnimState("TRANS_SelectedToIdle") end
			EndScript
		End

		
;---Transitions-------------------------------------

		TransitionState       = TRANS_EndDwarfToss
			Animation           = TOS4
				AnimationName     = DUGloin_TOS4
				AnimationMode     = ONCE
			End
		End	

		TransitionState       = TRANS_SelectedToIdle	
			Animation           = ATNC
				AnimationName     = DUGloin_ATNC
				AnimationMode     = ONCE
				AnimationSpeedFactorRange = 0.7 1.3
			End
		End
		
		TransitionState				=	TRANS_Select
			Animation				=	ATNA
				AnimationName		=	 DUGloin_ATNA
				AnimationMode		=	ONCE
			End
		End
	End
	
	;Draw module just for the HeroSelection
	;Draw = W3DScriptedModelDraw Icon
	;	ModelConditionState = NONE
	;		Model					= Icon02
	;	End
	;End
	
;;================== END ANIMATIONS =================================================================	


    #include "..\..\..\includes\StunDrawModuleSmall.inc"

	;// ***DESIGN parameters ***
	Side				= Dwarves
	EditorSorting		= UNIT
	ThreatLevel			= DAIN_THREAT_LEVEL
	TransportSlotCount	= TRANSPORTSLOTCOUNT_HERO
	BuildCost           = DAIN_BUILDCOST					
	BuildTime           = DAIN_BUILDTIME	
	ShockwaveResistance = SHOCKWAVE_RESISTANCE_STRONG
	;//DisplayMeleeDamage	= DAIN_DAMAGE
	
	HeroSortOrder		= 40
				
	WeaponSet
		Conditions 			= None 
		Weapon     			= PRIMARY  DwarvenDainAxe  		
		AutoChooseSources	= PRIMARY FROM_PLAYER FROM_SCRIPT FROM_AI		
	End

	ArmorSet
		Conditions      = None
		Armor           = ToughHeroArmor
		DamageFX        = NormalDamageFX
	End
	
	VisionRange			= VISION_STANDARD_MELEE				
	ShroudClearingRange = SHROUD_CLEAR_HERO
	
	MaxVisionBonusPercent = 300%
	VisionBonusTestRadius = 200
	VisionBonusPercentPerFoot = 1.0%

	BountyValue 	= DWARVEN_DAIN_BOUNTY_VALUE
	DisplayName 	= OBJECT:DwarvenDain
	RecruitText 	= CONTROLBAR:DwarvenDainRecruit
	ReviveText		= CONTROLBAR:DwarvenDainRevive
	Hotkey			= CONTROLBAR:DwarvenDainHotkey
	CrushableLevel	= 2  ;//What am I?: 0 = for infantry, 1 = for trees, 2 = general vehicles
	
	CommandSet  = DainCommandSet
	CommandPoints = 50


	; *** AUTO RESOLVE DATA *** 
	AutoResolveUnitType = AutoResolveUnit_Hero
	AutoResolveCombatChain = AutoResolve_HeroCombatChain

	AutoResolveBody = AutoResolve_DainBody
	
	AutoResolveArmor
		Armor = AutoResolve_DainArmor
	End

	AutoResolveWeapon
		Weapon = AutoResolve_DainWeapon
	End
	
	AutoResolveLeadership = AutoResolve_DainBonus


	;// *** AUDIO Parameters ***;

	VoiceAttack								= DainVoiceAttack
	VoiceAttackCharge						= DainVoiceAttackCharge
	VoiceAttackMachine						= DainVoiceAttack
	VoiceAttackStructure					= DainVoiceAttackBuilding
	VoiceFear 								= DainVoiceHelpMe
	VoiceGuard								= DainVoiceMove
	VoiceMove								= DainVoiceMove
	VoiceMoveToCamp							= DainVoiceMoveCamp
	VoiceMoveWhileAttacking					= DainVoiceDisengage
	VoicePriority							= 72
	VoiceRetreatToCastle					= DainVoiceRetreat
	VoiceSelect								= DainVoiceSelectMS
	VoiceSelectBattle 						= DainVoiceSelectBattle

	SoundImpact								= ImpactHorse

	UnitSpecificSounds
		VoiceGarrison						= DainVoiceMoveGarrison
		VoiceEnterUnitElvenTransportShip	= DainVoiceMoveShip
		VoiceInitiateCaptureBuilding		= DainVoiceCaptureBuilding
		;VoiceEnterStateInitiateCaptureBuilding	=
	End

	CrowdResponseKey = DwarfHero

    #include "..\..\..\includes\StandardUnitEvaEvents.inc"
	EvaEventDieOwner = DainDie			;//Eva event to trigger on unit's death. NOTICE THAT this is only for permanent deaths

	Behavior = LargeGroupAudioUpdate ModuleTag_LGAU		;// Tie into LargeGroupAudio system
		Key = Humanoid_Male Dwarf Dwarf_Male Unit Infantry Hero
	End

	ClientBehavior = ModelConditionAudioLoopClientBehavior ModuleTag_foo
		ModelCondition = Required:EMOTION_CELEBRATING	Excluded:DYING ENGAGED	Sound:EmotionDainVoxCheerLoop	;MOVING ATTACKING
		ModelCondition = Required:EMOTION_TAUNTING		Excluded:DYING ENGAGED	Sound:EmotionDainVoxTauntLoop	;MOVING ATTACKING
		ModelCondition = Required:EMOTION_POINTING		Excluded:DYING ENGAGED	Sound:EmotionDainVoxTauntLoop	;MOVING ATTACKING
		ModelCondition = Required:RAISING_FLAG			Excluded:DYING ENGAGED	Sound:EmotionDainVoxCheerLoop	;MOVING ATTACKING
	End

	ClientBehavior = AnimationSoundClientBehavior ModuleTag_AnimAudioBehavior
		MaxUpdateRangeCap = 800
		AnimationSound = Sound:FootstepDirtA			Animation:DUDain_SKL.DUDain_RUNA	Frames:3 14
		AnimationSound = Sound:FootstepDirtA			Animation:DUDain_SKL.DUDain_RUNB	Frames:3 12
		AnimationSound = Sound:BodyFallSoldier			Animation:DUDain_SKL.DUDain_LNDA	Frames:4
		AnimationSound = Sound:BodyFallSoldier			Animation:DUDain_SKL.DUDain_DIEA	Frames:11
		AnimationSound = Sound:BodyFallSoldier			Animation:DUDain_SKL.DUDain_DIEC	Frames:59
		AnimationSound = Sound:BodyFallSoldier			Animation:DUDAIN_SKL.DUDAIN_DTHA	Frames:73
		;AnimationSound = Sound:AxeDropSoundHere!		Animation:DUDAIN_SKL.DUDAIN_DTHA	Frames:21		;axe falls
		AnimationSound = Sound:SwordIntoGroundQuiet		Animation:DUDAIN_SKL.DUDAIN_IDLE	Frames:61		;striking ground with axe
		AnimationSound = Sound:TauntHumanHitShield		Animation:DUDAIN_SKL.DUDAIN_SPCA	Frames:25 50	;hitting shield and sword 
		AnimationSound = Sound:TauntHumanHitShield		Animation:DUDAIN_SKL.DUDAIN_TNTA	Frames:28 43	;hitting shield and sword 
	End

	;// *** ENGINEERING Parameters ***
	RadarPriority = UNIT
	KindOf = PRELOAD SELECTABLE CAN_CAST_REFLECTIONS INFANTRY PATH_THROUGH_EACH_OTHER SCORE THROWN_OBJECT HERO ARMY_SUMMARY ATTACK_NEEDS_LINE_OF_SIGHT HEAVY_MELEE_HITTER
	PathfindDiameter = 40.0
	
;//	Behavior = WeaponSetUpgrade ModuleTag_AxeThrow
;//		TriggeredBy = Upgrade_GimliAxeThrow
;//	End

	Body = RespawnBody ModuleTag_RespawnBody
		CheerRadius 				= EMOTION_CHEER_RADIUS
		MaxHealth         			= DAIN_HEALTH	;//BALANCE Dain Health
		PermanentlyKilledByFilter	= NONE			;//Who kills me permanently?
   		DodgePercent      			= 80%	
	End

	Behavior = RespawnUpdate ModuleTag_RespawnUpdate
		DeathAnim					= DYING					;//Model condition to play when killed-to-respawn
		DeathFX						= FX_DainDieToRespawn	;//FXList to play when killed-to-respawn
		DeathAnimationTime			= 4100					;//How long DeathAnim will take.
		InitialSpawnFX				= FX_DainInitialSpawn
		RespawnAnim					= LEVELED				;//Animation to play when respawning.
		RespawnFX					= FX_DainRespawn		;//FXList to play when respawning.
		RespawnAnimationTime		= 2000					;//Time it takes for respawn to play.
		AutoRespawnAtObjectFilter	= NONE +CASTLE_KEEP		;//Respawn at this location -- and at it's exit production point if possible.
		ButtonImage					= HIKingDain_res
		
		;//RespawnEntries determine the ruleset for how a character can be revived. Some units may automatically respawn, others
		;//may require a specific revive action performed on him. You can specify different values for each level... or use Level:Any
		RespawnRules =	AutoSpawn:No			Cost:1875		Time:60000		Health:100%		;//DEFAULT VALUES
	End
 	
 	Behavior = AutoHealBehavior ModuleTag_AthelasHealing
		StartsActive				= Yes	; Active, as in no upgrade required
		ButtonTriggered				= Yes	; But doesn't actually run on its own.
		HealingAmount				= ATHELAS_HEAL_AMOUNT
		Radius						= 200
		HealOnlyOthers				= No
		SingleBurst					= Yes
		UnitHealPulseFX				= FX_DainMightyRage
		KindOf						= INFANTRY CAVALRY
	End

	Behavior = AutoHealBehavior ModuleTag_ElvenGiftHealing
		StartsActive				= No
		TriggeredBy					= Upgrade_ElvenGift
		HealingAmount				= ELVEN_GIFT_REGEN_AMOUNT
		HealingDelay				= ELVEN_GIFT_REGEN_DELAY
		StartHealingDelay			= HERO_HEAL_DELAY
		HealOnlyIfNotInCombat		= Yes
	End

	Behavior = AutoHealBehavior ModuleTag_DainHealing
		StartsActive			= Yes
		HealingAmount			= HERO_HEAL_AMOUNT
		HealingDelay			= 1000
		StartHealingDelay		= HERO_HEAL_DELAY
		HealOnlyIfNotInCombat	= Yes
	End
	
	Behavior = StancesBehavior ModuleTag_StancesBehavior
        StanceTemplate = Hero
    End
  
	#include "..\..\..\includes\CaptureBuilding.inc"
		
	Behavior = AIUpdateInterface ModuleTag_03
		AutoAcquireEnemiesWhenIdle		= Yes ATTACK_BUILDINGS
		MoodAttackCheckRate				= 500
		HoldGroundCloseRangeDistance	= 60
	End

	LocomotorSet
		Locomotor = RohanGimliLocomotor
		Condition = SET_NORMAL 
		Speed     = NORMAL_DWARF_HERO_SPEED
	End

	Behavior = PhysicsBehavior ModuleTag_04
		GravityMult				= 1.0
		AllowBouncing			= No
		ShockStunnedTimeLow		= 1400	;//msec
		ShockStunnedTimeHigh	= 2400	;//msec
		ShockStandingTime		= 2600	;//msec
	End 

	Behavior = SlowDeathBehavior ModuleTag_05
		DeathTypes			= ALL -KNOCKBACK
		SinkDelay			= 3000
		SinkRate			= 0.40     ;// in Dist/Sec
		DestructionDelay	= 8000
		Sound				= INITIAL DainVoiceDie
	End
	
	Behavior = SquishCollide ModuleTag_06
		;//nothing
	End
	
	Behavior = SlowDeathBehavior ModuleTag_07
		;// Same as normal death, but no sound (sound already played by SoundImpact = ... )
		DeathTypes			= NONE +KNOCKBACK
		SinkDelay			= 3000
		SinkRate			= 0.40     ;// in Dist/Sec
		DestructionDelay	= 8000
	End
	
    Behavior = EmotionTrackerUpdate	Module_EmotionTracker
		TauntAndPointDistance		=	300		;// max distance to taunted/pointed objet
 		TauntAndPointUpdateDelay	=	1000	;// how often scan (milliseconds) 		
		AddEmotion			=	Doom_Base
		//	AddEmotion			=   BraceForBeingCrushed_Base
		//	AddEmotion			=	FearIdle_Base
		//	AddEmotion			=	FearBusy_Base
		AddEmotion			=	Point_Base
		AddEmotion			=	Taunt_Base
 		AddEmotion			=	CheerIdle_Base
		AddEmotion			=	CheerBusy_Base
		//	AddEmotion			=	HeroCheerIdle_Base
		//	AddEmotion			=	HeroCheerBusy_Base
		AddEmotion			=	Alert_Base
		AddEmotion			=	CheerForAboutToCrush_Base
 	End	
	
	Behavior = HitReactionBehavior HitReactionBehaviorModuleTag
		HitReactionLifeTimer1 = 2200	;// level 1 (light  damage)  hit reaction animations in frames (5 per sec)
		HitReactionLifeTimer2 = 15		;// level 2 (medium damage)  hit reaction animations in frames (5 per sec)
		HitReactionLifeTimer3 = 10		;// level 3 (heavy  damage)  hit reaction animations in frames (5 per sec)

		HitReactionThreshold1 = 1.0		;// level 1 (light  damage) threshold trigger
		HitReactionThreshold2 = 2500.0  ;// level 2 (medium damage) threshold trigger
		HitReactionThreshold3 = 5000.0  ;// level 3 (heavy  damage) threshold trigger
	End
	
	;--------------------------------------------------------------------------------------------
	;//-------------------------Dain's Stubborn Pride--------------------------------------
	;--------------------------------------------------------------------------------------------
	Behavior = UnpauseSpecialPowerUpgrade ModuleTag_StubbornPrideUnpause
		SpecialPowerTemplate		= SpecialAbilityDainStubbornPride
		TriggeredBy					= Upgrade_DainStubbornPride
	End

	Behavior = SpecialPowerModule ModuleTag_StubbornPrideSpecialPower
		SpecialPowerTemplate		= SpecialAbilityDainStubbornPride
		UpdateModuleStartsAttack	= No
		StartsPaused				= Yes
	End	

	Behavior = AttributeModifierAuraUpdate ModuleTag_StubbornPrideUpdate
		StartsActive				= No
		BonusName					= DainStubbornPride
		TriggeredBy					= Upgrade_DainStubbornPride
		RefreshDelay				= 2000
		Range						= 200
		ObjectFilter				= ANY +INFANTRY +CAVALRY -STRUCTURE -BASE_FOUNDATION -HERO -DOZER ALLIES
	End	
	
	;--------------------------------------------------------------------------------------------
	;//-------------------------Dain's Leadership--------------------------------------
	;--------------------------------------------------------------------------------------------
	Behavior = UnpauseSpecialPowerUpgrade ModuleTag_DainLeadership
		SpecialPowerTemplate	= SpecialAbilityFakeLeadership
		TriggeredBy				= Upgrade_DainLeadership
	End
	
	Behavior = SpecialPowerModule ModuleTag_DainLeadershipUpdate   
		SpecialPowerTemplate		= SpecialAbilityFakeLeadership
		UpdateModuleStartsAttack	= No
		StartsPaused				= Yes
	End	

	Behavior = AttributeModifierAuraUpdate ModuleTag_Leadership
		StartsActive	= No ;If no, requires upgrade to turn on.
		BonusName		= GenericHeroLeadership
		TriggeredBy		= Upgrade_DainLeadership
		RefreshDelay	= 2000
		Range			= 200
		AntiCategory	= BUFF
		ObjectFilter	= GENERIC_BUFF_RECIPIENT_OBJECT_FILTER
	End	

	;--------------------------------------------------------------------------------------------
	;//-------------------------Dain's Mighty Rage: Mighty Rage--------------------------------------
	;--------------------------------------------------------------------------------------------
	
	Behavior = UnpauseSpecialPowerUpgrade ModuleTag_MightyRageStarter
		SpecialPowerTemplate			= SpecialAbilityDainMightyRage
		TriggeredBy						= Upgrade_DainMightyRage
		ObeyRechageOnTrigger		= Yes
	End
	Behavior = SpecialPowerModule ModuleTag_DainMightyRageDummy
		SpecialPowerTemplate			= SpecialAbilityDainMightyRage
		StartsPaused					= Yes
		UpdateModuleStartsAttack		= Yes
	End
	
	Behavior = ActivateModuleSpecialPower ModuleTag_CloseTheGap
		SpecialPowerTemplate			= SpecialAbilityDainMightyRage
		StartAbilityRange				= 200
		TriggerSpecialPower				= ModuleTag_MightyRageHeal		TARGETPOS
		TriggerSpecialPower				= ModuleTag_MightyRageBuff		TARGETPOS
		TriggerSpecialPower				= ModuleTag_MightyRageDebuff		TARGETPOS
		TriggerSpecialPower				= ModuleTag_MightyRageSelfBuff	TARGETPOS
	End

	Behavior = SpecialPowerModule ModuleTag_MightyRageSelfBuff
		SpecialPowerTemplate			= SpecialAbilityActivateeDummy
		AttributeModifier				= DainMightyRageSelfBuff
		AttributeModifierRange			= DAIN_MIGHTYRAGE_EFFECT_RADIUS
		;AttributeModifierAffects		= GENERIC_BUFF_RECIPIENT_OBJECT_FILTER
		AttributeModifierAffects	=  NONE +DwarvenDain ;+DwarvenCaptainofDale
		AttributeModifierAffectsSelf 	= Yes
	End
	
	Behavior = PlayerHealSpecialPower ModuleTag_MightyRageHeal
		SpecialPowerTemplate			= SpecialAbilityActivateeDummy
		HealAmount						= 1.0
		HealAsPercent					= Yes
		HealAffects						= INFANTRY CAVALRY HERO DOZER MONSTER
		HealRadius						= DAIN_MIGHTYRAGE_EFFECT_RADIUS
		HealFX							= FX_SpellHealUnitHealBuff
		InitiateSound					= DainMightyRage
		TriggerFX						= FX_DainMightyRage02
	End

	Behavior = SpecialPowerModule ModuleTag_MightyRageBuff
		SpecialPowerTemplate			= SpecialAbilityActivateeDummy
		AttributeModifier				= DainMightyRageBuff
		AttributeModifierRange			= DAIN_MIGHTYRAGE_EFFECT_RADIUS
		AttributeModifierAffects		= GENERIC_BUFF_RECIPIENT_OBJECT_FILTER
	End


	Behavior = SpecialPowerModule ModuleTag_MightyRageDebuff
		SpecialPowerTemplate			= SpecialAbilityActivateeDummy
		AttributeModifier				= DainRageDeBuff
		AttributeModifierRange			= DAIN_MIGHTYRAGE_EFFECT_RADIUS
		AttributeModifierAffects		= GENERIC_BUFF_RECIPIENT_OBJECT_FILTER
		AntiCategory					= LEADERSHIP BUFF
	End

 	;-------------------------------------------------------------------------------------------------
	;//-------------------------Dain's 	Summon Royal Guard--------------------------------------------
	;-------------------------------------------------------------------------------------------------
	Behavior = UnpauseSpecialPowerUpgrade ModuleTag_DainSummonEnabler
		SpecialPowerTemplate = SpecialAbilityDainSummonRoyalGuard
		TriggeredBy = Upgrade_DainRoyalGuard
		ObeyRechageOnTrigger		= Yes
	End

	Behavior = OCLSpecialPower ModuleTag_OCLSpecialPower
		SpecialPowerTemplate	= SpecialAbilityDainSummonRoyalGuard
		OCL						= OCL_SpawnDwarvenEgg
		CreateLocation			= CREATE_AT_LOCATION
		StartsPaused			= Yes
		;SetModelCondition		= ModelConditionState:USER_1
		;SetModelConditionTime	= 8.1
	End

	;-------------------------------MOUNT WAGON------------------------------------------------------------------------
 	Behavior = SpecialPowerModule ModuleTag_EagleToggleStarter                      
 		SpecialPowerTemplate		= SpecialAbilityShapeshiftOne
 		UpdateModuleStartsAttack	= Yes
 		StartsPaused				= Yes
		;InitiateSound				= FellBeastVoiceMove
 	End

	Behavior = ToggleMountedSpecialAbilityUpdate ModuleTag_EagleToggle
 		SpecialPowerTemplate    = SpecialAbilityShapeshiftOne
 		MountedTemplate			= DwarvenDainBattleWagon 
 		SynchronizeTimerOnSpecialPower = SpecialAbilityDainSummonRoyalGuard SpecialAbilityDainMightyRage
 		UnpackTime              = 2000
 		PreparationTime         = 0			; none, cause we hop onto our mount in no time at all :)
 		PackTime                = 0 		; none, cause we hop onto our mount in no time at all :)
 		OpacityTarget			= .0		; How see-thru to be at peak of change
 		AwardXPForTriggering    = 0
 		IgnoreFacingCheck		= Yes
		;TriggerSound			= FellBeastVoiceMove
            UnpackingVariation		= 1
	End

      Behavior = UnpauseSpecialPowerUpgrade ModuleTag_UnpauseEagle
		SpecialPowerTemplate = SpecialAbilityShapeshiftOne
		TriggeredBy = Upgrade_ObjectLevel5
	End

	Behavior = AttributeModifierUpgrade ModuleTag_ElvenGiftBonus
		TriggeredBy			= Upgrade_ElvenGift
		AttributeModifier	= SpellBookElvenGifts
	End
	
	;///////////////////
	; AISpecialPowers
	;///////////////////
	
	Behavior = AISpecialPowerUpdate GondorFighterHordeStanceBattle
		CommandButtonName = Command_SetStanceBattle
		SpecialPowerAIType = AI_SPECIAL_POWER_STANCEBATTLE
	End

	Behavior = AISpecialPowerUpdate GondorFighterHordeStanceAggressive
		CommandButtonName = Command_SetStanceAggressive
		SpecialPowerAIType = AI_SPECIAL_POWER_STANCEAGGRESSIVE
	End

	Behavior = AISpecialPowerUpdate GondorFighterHordeHoldGround
		CommandButtonName = Command_SetStanceHoldGround
		SpecialPowerAIType = AI_SPECIAL_POWER_STANCEHOLDGROUND
	End

	
	Behavior = AISpecialPowerUpdate RoyalGuardAI
		CommandButtonName = Command_SpecialAbilityDainSummonRoyalGuard
		SpecialPowerAIType = AI_SPECIAL_POWER_TARGETAOE_SUMMON
		SpecialPowerRadius = 30.0
	End
	
	Behavior = AISpecialPowerUpdate MightyRageAI
		CommandButtonName = Command_SpecialAbilityDainMightyRage
		SpecialPowerAIType = AI_SPECIAL_POWER_HEAL_AOE
		SpecialPowerRadius = 200.0
	End
	
	Behavior = AISpecialPowerUpdate StubbornPrideAI
		CommandButtonName = Command_SpecialAbilityStubbornPride
		SpecialPowerAIType = AI_SPECIAL_POWER_BASIC_SELF_BUFF
	End
	
	
	Geometry			= CYLINDER
	GeometryMajorRadius = 5.6
	GeometryMinorRadius = 5.6
	GeometryHeight		= 16.0
	GeometryIsSmall		= Yes
	
	Shadow				= SHADOW_DECAL
	ShadowSizeX			= 19
	ShadowSizeY			= 19
	ShadowTexture		= ShadowI
End

;//------------------------------------------------------------------------------
;// aka BattleWagon
Object DwarvenDainBattleWagon                         ;//BALANCE BattleWagon 
  ;// *** ART Parameters ***
  
    ;//SelectPortrait for Heros is portrait behind skill buttons. HP = HeroPortrait.
	SelectPortrait = HPKingDain
    
    ;// ButtonImage for Heros is button image on Hero Select UI to select hero. HI = HeroIcon or HeroImage.
	ButtonImage = HIKingDain
	
	DescriptionStrategic = CONTROLBAR:LW_ToolTip_Dain

    #include "..\..\..\includes\StunDrawModuleLarge.inc"

	Draw = W3DScriptedModelDraw DustEffects
	    DefaultModelConditionState
	      Model = None
	    End
	    IdleAnimationState
	    End
	    AnimationState =  MOVING WADING
			ParticleSysBone = None FootstepSlash
	    End
	    AnimationState = MOVING ACCELERATE
			ParticleSysBone = None GenericSiegeTrailDust
	    End
	    AnimationState =  MOVING ACCELERATE
			ParticleSysBone = None GenericSiegeTrailDust
	    End
	    AnimationState = MOUNTED MOVING
	    End
	End

	

	Draw = W3DScriptedModelDraw DrawSpawnFX
		DefaultModelConditionState
			Model               = None
		End

		ModelConditionState	= USER_2
			Model	= None
			FXEvent	= Frame:0 Name:FX_HordeResurrection
		End
	End 

	Draw = W3DTruckDraw ModuleTag_01  
		
		ExtraPublicBone			= PASS01
		ExtraPublicBone			= PASS02
		
		OkToChangeModelColor	= Yes
  	  
		StaticModelLODMode		= yes ;// Will append M or L to the skin name depending on GameLOD

		DefaultModelConditionState
			Model               = DUDnBtlWgn_SKN
			Skeleton			= DUBtlWagon_SKL
			WeaponLaunchBone	= PRIMARY BONE01
		End

		ModelConditionState	= DYING
			Model				= DUBtlWagon_DIEA
			Skeleton			= DUBtlWagon_DIEA
		End

		RandomTexture 	= dudainmth.tga 0 dudain.tga
		RandomTexture 	= dudnbtlwagon.tga 0 dubtlwagon.tga

		TrackMarks					= EXTireTrack2_Temp.tga
		TrackMarksLeftBone			= Wheel_L
		TrackMarksRightBone			= Wheel_R				
		LeftRearTireBone            = Wheel_L
		RightRearTireBone           = Wheel_R
		TireRotationMultiplier      = 0.07   ; this * speed = rotation.
		PowerslideRotationAddition  = 1.5   ; This speed is added to the rotation speed when powersliding.
    
		;//------ANIMATIONS------
		IdleAnimationState 
			Animation			= IDLA  
				AnimationName		= DUBtlWagon_IDLA
				AnimationPriority	= 5	;// will be chosen 5 times more often than a default (1) priority animation.
			End
			Animation = IDLB 
				AnimationName = DUBtlWagon_IDLB
			End
			StateName = Idle
		End
	   
		AnimationState         = DYING
			Animation            = DIEA
				AnimationName      = DUBtlWagon_DIEA
				AnimationMode      = ONCE
				AnimationBlendTime = 0
			End
		End


		AnimationState						= PARALYZED
			Animation
				AnimationName				= DUBtlWagon_IDLA
				AnimationMode				= LOOP
			End
		End

;-----------Just Built animation
		ModelConditionState =JUST_BUILT
			Model	=  DUBtlWagon_SKN
		End
	    
		AnimationState  = JUST_BUILT
			Animation			= Being_Built
				AnimationName		= DUBtlWagon_BLDA
				AnimationMode		= ONCE
				AnimationBlendTime = 0		; Can't blend here, as this anim is offset from the object position.
			End
		End

		;//;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
		;// Moving animations
		;//;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
		AnimationState			= MOVING TURN_LEFT
			Animation			= Turn
				AnimationName		= DUBtlWagon_TNLA
				AnimationMode       = LOOP
				AnimationBlendTime  = 10
			End
		End
		
		AnimationState	= MOVING TURN_RIGHT
			Animation		= Turn
				AnimationName		= DUBtlWagon_TNRA
				AnimationMode       = LOOP
				AnimationBlendTime  = 10
			End
		End	
	    
		AnimationState			= TURN_LEFT
			Animation			= Turn
				AnimationName		= DUBtlWagon_TNLB
				AnimationMode       = LOOP
				AnimationBlendTime  = 10
			End
		End
		
		AnimationState	= TURN_RIGHT
			Animation		= Turn
				AnimationName		= DUBtlWagon_TNRB
				AnimationMode       = LOOP
				AnimationBlendTime  = 10
			End
		End	

		AnimationState	= MOVING BACKING_UP
			Animation		= BackingUp
				AnimationName		=	DUBtlWagon_BAKA
				AnimationMode		=	LOOP
			End
			Flags					=	RANDOMSTART
		End	

		AnimationState	= MOVING			
			ShareAnimation	= Yes;
			Animation			= RUNB
				AnimationName			= DUBtlWagon_RUNA
				AnimationMode			= LOOP
				Distance				= 30
				AnimationBlendTime		= 10
			End
			Flags			= RANDOMSTART			
		End

		AnimationState						= ATTACKING_STRUCTURE FIRING_OR_PREATTACK_A  ; Melee attack for ranged units
			Animation						= ATKB
				AnimationName				= DUBtlWagon_ATKA
				AnimationMode				= ONCE
				UseWeaponTiming				= Yes
			End
		End

		AnimationState						= FIRING_OR_PREATTACK_A  ; Melee attack for ranged units
			Animation						= ATKB
				AnimationName				= DUBtlWagon_ATKA
				AnimationMode				= ONCE
				UseWeaponTiming				= Yes
			End
		End
		
		AnimationState						= EMOTION_CELEBRATING
			Animation
				AnimationName				= DUBtlWagon_CHRA
				AnimationMode				= LOOP
			End						
			Flags							= RANDOMSTART
		End
	End
	
	; WARNING WARNING WARNING
	; DO NOT put any draw modules here, add new draw modules to the TOP of the INI.
	; "W3DTruckDraw" must be the last draw module in the INI for PASSENGER_VARIATION_1 to work.
	; Otherwise, subsequent draw modules will blow away ExtraPublicBone info in W3DTruckDraw.
	; WARNING WARNING WARNING
	
		
	;// ***DESIGN parameters ***
	Side						= Dwarves
	EditorSorting				= UNIT
	
	ThreatLevel					= DWARVEN_BATTLEWAGON_THREAT_LEVEL
	ThreatBreakdown DwarvenBattleWagon_DetailedThreat
		AIKindOf = CAVALRY
	End
	
	ShowHealthInSelectionDecal	= Yes
	TransportSlotCount			= TRANSPORTSLOTCOUNT_MACHINE
	ShockwaveResistance			= SHOCKWAVE_RESISTANCE_IMMUNE
  
	ArmorSet
		Conditions      = None
		Armor           = WagonHeroArmor
		;//DamageFX        = MumakilDamageFX
	End
	
	WeaponSet
		Conditions			= None 
		Weapon				= PRIMARY    YurgDainHorn
		
	End
  	
	VisionRange			= VISION_STANDARD_MELEE				
	ShroudClearingRange = SHROUD_CLEAR_HERO
	
	MaxVisionBonusPercent = 300%
	VisionBonusTestRadius = 200
	VisionBonusPercentPerFoot = 1.0%

	BountyValue 	= DWARVEN_DAIN_BOUNTY_VALUE
	DisplayName 	= OBJECT:DwarvenDain
	RecruitText 	= CONTROLBAR:DwarvenDainRecruit
	ReviveText		= CONTROLBAR:DwarvenDainRevive
	Hotkey			= CONTROLBAR:DwarvenDainHotkey
	
	CrusherLevel        		= 2				;//What can I crush?: 1 = infantry, 2 = trees, 3 = vehicles
	CrushWeapon			= DainBattleWagonCrush  
	MinCrushVelocityPercent		= 40				;// Has to be moving at at least 30% of full speed.
	CrushDecelerationPercent	= 3	
	CommandSet  = DainBattleWagonCommandSet
	CommandPoints = 50
 
	;// *** AUDIO Parameters ***;

	;VoiceAmbushed							= DwarfBattleWagonVoiceAmbushed	
	VoiceAttack								= DwarfBattleWagonVoiceAttack
	VoiceAttackCharge						= DwarfBattleWagonVoiceAttackCharge
	VoiceAttackMachine						= DwarfBattleWagonVoiceAttack
	VoiceAttackStructure					= DwarfBattleWagonVoiceAttackBuilding
	VoiceCreated							= DwarfBattleWagonVoiceSalute
	VoiceFullyCreated 						= DwarfBattleWagonVoiceSalute
	VoiceGuard								= DwarfBattleWagonVoiceMove
	VoiceMove								= DwarfBattleWagonVoiceMove
	VoiceMoveToCamp							= DwarfBattleWagonVoiceMoveCamp
	VoiceMoveWhileAttacking					= DwarfBattleWagonVoiceDisengage
	VoicePriority							= 58
	VoiceRetreatToCastle					= DwarfBattleWagonVoiceRetreat		
	VoiceSelect								= DwarfBattleWagonVoiceSelectMS
	VoiceSelectBattle 						= DwarfBattleWagonVoiceSelectBattle			

	;VoiceEnterStateAttack					= DwarfBattleWagonVoiceEnterStateAttack
	;VoiceEnterStateAttackCharge			= DwarfBattleWagonVoiceEnterStateAttackCharge
	;VoiceEnterStateAttackMachine			= DwarfBattleWagonVoiceEnterStateAttackBuilding
	;VoiceEnterStateAttackStructure			= DwarfBattleWagonVoiceEnterStateAttackBuilding
	;VoiceEnterStateMove					= DwarfBattleWagonVoiceEnterStateMove
	;VoiceEnterStateMoveToCamp				= DwarfBattleWagonVoiceEnterStateMoveCamp
	;VoiceEnterStateMoveWhileAttacking		= DwarfBattleWagonVoiceEnterStateDisengage
	;VoiceEnterStateRetreatToCastle			= DwarfBattleWagonVoiceEnterStateRetreat

	UnitSpecificSounds
		VoiceGarrison						= DwarfBattleWagonVoiceMove
		VoiceEnterUnitElvenTransportShip	= DwarfBattleWagonVoiceMoveShip
		VoiceInitiateCaptureBuilding		= DwarfBattleWagonVoiceMove
		;VoiceEnterStateInitiateCaptureBuilding	=
	End

	SoundAmbient							= DwarfRhinocerousVoxAmbientLoop
	SoundImpact 							= ImpactHorse
	SoundMoveLoop							= DwarfBattleWagonMoveLoop

	CrowdResponseKey = Dwarf

	Behavior = LargeGroupAudioUpdate ModuleTag_LGAU
		Key = Humanoid_Male Dwarf Dwarf_Male Dwarf_BattleWagon Dwarf_Siege
		UnitWeight = 2
	End

	ClientBehavior = ModelConditionAudioLoopClientBehavior ModuleTag_foo
		ModelCondition = Required:EMOTION_CELEBRATING	Excluded:DYING ENGAGED	Sound:EmotionDwarfCompilationVoxCheerSinglesLoop	;MOVING ATTACKING
		ModelCondition = Required:EMOTION_POINTING		Excluded:DYING ENGAGED	Sound:EmotionDwarfCompilationVoxTauntSinglesLoop	;MOVING ATTACKING
		ModelCondition = Required:EMOTION_TAUNTING		Excluded:DYING ENGAGED	Sound:EmotionDwarfCompilationVoxTauntSinglesLoop	;MOVING ATTACKING
		ModelCondition = Required:RAISING_FLAG			Excluded:DYING ENGAGED	Sound:EmotionDwarfCompilationVoxTauntSinglesLoop
	End

    #include "..\..\..\includes\StandardUnitEvaEvents.inc"

	;// *** ENGINEERING Parameters ***

	RadarPriority = UNIT
	KindOf = HERO PRELOAD SELECTABLE CAN_CAST_REFLECTIONS CAVALRY SCORE CAN_ATTACK ATTACK_NEEDS_LINE_OF_SIGHT PATH_THROUGH_INFANTRY TRANSPORT CAN_ATTACK_WALLS ARMY_SUMMARY NOTIFY_OF_PREATTACK MACHINE 
	CamouflageDetectionMultiplier = 0.8
	
	BuildCost = DWARVEN_BATTLEWAGON_BUILDCOST
	BuildTime = DWARVEN_BATTLEWAGON_BUILDTIME

	Behavior = StancesBehavior ModuleTag_StancesBehavior
        StanceTemplate = Hero
        End

	Body = RespawnBody ModuleTag_RespawnBody
		CheerRadius 				= EMOTION_CHEER_RADIUS
		MaxHealth         			= 4000 ;DAIN_HEALTH	;//BALANCE Dain Health
		PermanentlyKilledByFilter	= NONE			;//Who kills me permanently?
   		DodgePercent      			= 80%	
	End

	Behavior = RespawnUpdate ModuleTag_RespawnUpdate
		DeathAnim					= DYING					;//Model condition to play when killed-to-respawn
		DeathFX						= FX_DainDieToRespawn	;//FXList to play when killed-to-respawn
		DeathAnimationTime			= 4100					;//How long DeathAnim will take.
		InitialSpawnFX				= FX_DainInitialSpawn
		RespawnAnim					= LEVELED				;//Animation to play when respawning.
		RespawnFX					= FX_DainRespawn		;//FXList to play when respawning.
		RespawnAnimationTime		= 2000					;//Time it takes for respawn to play.
		AutoRespawnAtObjectFilter	= NONE +CASTLE_KEEP		;//Respawn at this location -- and at it's exit production point if possible.
		ButtonImage					= HIKingDain_res
		RespawnAsTemplate			= DwarvenDain
		
		;//RespawnEntries determine the ruleset for how a character can be revived. Some units may automatically respawn, others
		;//may require a specific revive action performed on him. You can specify different values for each level... or use Level:Any
		RespawnRules =	AutoSpawn:No			Cost:1875		Time:60000		Health:100%		;//DEFAULT VALUES
	End
 	
 	Behavior = AutoHealBehavior ModuleTag_AthelasHealing
		StartsActive				= Yes	; Active, as in no upgrade required
		ButtonTriggered				= Yes	; But doesn't actually run on its own.
		HealingAmount				= ATHELAS_HEAL_AMOUNT
		Radius						= 200
		HealOnlyOthers				= No
		SingleBurst					= Yes
		UnitHealPulseFX				= FX_DainMightyRage
		KindOf						= INFANTRY CAVALRY
	End

	Behavior = AutoHealBehavior ModuleTag_ElvenGiftHealing
		StartsActive				= No
		TriggeredBy					= Upgrade_ElvenGift
		HealingAmount				= ELVEN_GIFT_REGEN_AMOUNT
		HealingDelay				= ELVEN_GIFT_REGEN_DELAY
		StartHealingDelay			= HERO_HEAL_DELAY
		HealOnlyIfNotInCombat		= Yes
	End

	Behavior = AutoHealBehavior ModuleTag_DainHealing
		StartsActive			= Yes
		HealingAmount			= HERO_HEAL_AMOUNT
		HealingDelay			= 1000
		StartHealingDelay		= HERO_HEAL_DELAY
		HealOnlyIfNotInCombat	= Yes
	End
	
	Behavior = CommandSetUpgrade ModuleTag_CommandSetUpgrade
		TriggeredBy			= Upgrade_BattleWagonAxeThrowers Upgrade_BattleWagonBannerCarrier Upgrade_BattleWagonMenOfDale Upgrade_BattleWagonHearth
		CommandSet			= DwarvenBattleWagonCommandSet_Upgraded
	End
	
	;// Banner Carrier
	Behavior = AttributeModifierAuraUpdate ModuleTag_BannerCarrierBuff
		StartsActive			= Yes
		BonusName				= GenericHeroLeadership
		;TriggeredBy				= Upgrade_BattleWagonBannerCarrier
		RefreshDelay			= 2000
		Range					= 200
		AntiCategory			= BUFF
		ObjectFilter			= GENERIC_BUFF_RECIPIENT_OBJECT_FILTER -DwarvenBattleWagonAxeThrower -DwarvenBattleWagonMenOfDale -DwarvenBattleWagonPhalanx
	End
	Behavior = AutoHealBehavior ModuleTag_BannerCarrierHeal
		StartsActive			= Yes
		;TriggeredBy				= Upgrade_BattleWagonBannerCarrier
		HealingAmount			= 30
		HealingDelay			= 2000
		HealOnlyIfNotInCombat	= Yes
		UnitHealPulseFX			= FX_SpellHealUnitHealBuff
		NonStackable			= Yes
	End
	Behavior = ModelConditionUpgrade ModuleTag_BannerObject
		TriggeredBy				= Upgrade_ObjectLevel5
		AddConditionFlags		= USER_1
	End

	;Behavior = SubObjectsUpgrade Show_Topper
		;TriggeredBy		= Upgrade_ObjectLevel5
		;RequiresAllTriggers = Yes
		;ShowSubObjects	= Glow
	;End	
		
	;// Hearth
	Behavior = AutoHealBehavior ModuleTag_HearthHeal
		StartsActive			= No
		TriggeredBy				= Upgrade_BattleWagonHearth
		HealingAmount			= 30
		Radius					= 100
		HealingDelay			= 2000
		UnitHealPulseFX			= FX_SpellHealUnitHealBuff
		NonStackable			= Yes
		RespawnNearbyHordeMembers = Yes
		RespawnFXList			= FX_BannerCarrierSpawnUnit
		RespawnMinimumDelay		= 100 ; 20 second delay
	End

	Behavior = StealthDetectorUpdate ModuleTag_HearthStealthDetect
		DetectionRange			= 200
		DetectionRate			= 2000
		CancelOneRingEffect 	= Yes
		RequiredUpgrade			= Upgrade_BattleWagonHearth
	End
	
	Behavior = SpecialPowerModule ModuleTag_OilBarrelsStarter
		SpecialPowerTemplate		= SpecialAbilityDwarvenBattleWagonOilBarrels
		UpdateModuleStartsAttack	= Yes
		InitiateSound				= DwarfBattleWagonVoiceAttackOilBarrels
	End
	
	Behavior = WeaponFireSpecialAbilityUpdate ModuleTag_OilBarrelUpdate
		SpecialPowerTemplate		= SpecialAbilityDwarvenBattleWagonOilBarrels
		WhichSpecialWeapon			= 1
		PackTime					= 500
		StartAbilityRange			= BATTLEWAGON_OILBARREL_RANGE
		SpecialWeapon				= BattleWagonOilBarrel
		IgnoreFacingCheck			= Yes
	End
	
	Behavior = AIUpdateInterface ModuleTag_03
		AILuaEventsList				= DwarvenBattleWagonFunctions		
		AutoAcquireEnemiesWhenIdle	= No
		AttackPriority				= AttackPriority_Cavalry
	End

   	Behavior = EmotionTrackerUpdate	Module_EmotionTracker
		AddEmotion			=	Terror_Base
		AddEmotion			=	Doom_Base
		AddEmotion			=   BraceForBeingCrushed_Base
		AddEmotion			=	UncontrollableFear_Base
		AddEmotion			=	FearIdle_Base
		AddEmotion			=	FearBusy_Base
		AddEmotion			=	Point_Base
		AddEmotion			=	Taunt_Base
 		AddEmotion			=	CheerIdle_Base
		AddEmotion			=	CheerBusy_Base
		AddEmotion			=	HeroCheerIdle_Base
		AddEmotion			=	HeroCheerBusy_Base
		AddEmotion			=	Alert_Base
		AddEmotion			=	CheerForAboutToCrush_Base
	End

	Behavior = NotifyTargetsOfImminentProbableCrushingUpdate ModuleTag_NotifyCrushScan
	End

	Behavior LifetimeUpdate LifetimeTag
		WaitForWakeUp	=	Yes
	End

	Behavior = TransportContain  ModuleTag_12
		ObjectStatusOfContained				= UNSELECTABLE CAN_ATTACK
		Slots								= 2		
		DamagePercentToUnits				= 100%
		PassengerFilter						= ANY +DwarvenBattleWagonAxeThrower +DwarvenBattleWagonMenOfDale +DwarvenBattleWagonPhalanx; only allow these (through upgrades)
		AllowOwnPlayerInsideOverride		= Yes	;// Normally, the Allies check encompasses OwnPlayer.  but we reeeeally only want our own guys.
		AllowAlliesInside					= Yes
		AllowEnemiesInside					= No
		AllowNeutralInside					= No
		ExitDelay							= 0		
		ForceOrientationContainer			= Yes	;// otherwise contained units can't orient themselves towards their targets...		
		PassengerBonePrefix					= PassengerBone:PASS KindOf:INFANTRY		
		
		;//Left side -- so crew members use right handed animations
		BoneSpecificConditionState 1 PASSENGER_VARIATION_1				
		;//Right side -- so crew members use left handed animations
		BoneSpecificConditionState 2 PASSENGER_VARIATION_2		
			
		ShowPips							= No
		EjectPassengersOnDeath				= No ;// Don't eject. Otherwise the passengers will linger if the wagon is decomissioned.
		KillPassengersOnDeath				= Yes
		
		FadeFilter							= ALL	
		
		UpgradeCreationTrigger				= Upgrade_ObjectLevel1 DwarvenBattleWagonRoyalAxeThrower 2
		UpgradeCreationTrigger				= Upgrade_BattleWagonMenOfDale DwarvenBattleWagonMenOfDale 2
		UpgradeCreationTrigger				= Upgrade_BattleWagonBannerCarrier DwarvenBattleWagonPhalanx 2
	End

	Behavior = ModelConditionUpgrade ModuleTag_SpawnFX
		TriggeredBy				= Upgrade_BattleWagonMenOfDale Upgrade_BattleWagonAxeThrowers Upgrade_BattleWagonBannerCarrier
		AddTempConditionFlag	= ModelConditionState:USER_2
		TempConditionTime		= 0.01
	End

	LocomotorSet
		Locomotor = BattleWagonLocomotor
		Condition = SET_NORMAL 
		Speed     = NORMAL_MOUNTED_SLOW_HORDE_SPEED
	End
	
	Behavior = PhysicsBehavior ModuleTag_04
	End
  
	Behavior = SlowDeathBehavior ModuleTag_05
		DeathTypes			= ALL
		SinkDelay			= 5000
		SinkRate			= 2.4		;//in Dist/Sec
		DestructionDelay	= 15000
		DecayBeginTime		= 6000
		ProbabilityModifier	= 10		;// Very, very unlikely unless clearance test fails
		DeathFlags			= DEATH_1	;// Controls animation and weapon choice. Sets BOTH model condition and object status bits.
		ShadowWhenDead		= Yes		;// Volumetric shadows don't look so bad when sinking into ground
		Sound				= INITIAL DwarfBattleWagonDieMS
	End

	Behavior = SquishCollide ModuleTag_06 
	End
  
	Behavior = HitReactionBehavior HitReactionBehaviorModuleTag
		HitReactionLifeTimer1 = 1000	;// level 1 (light  damage)  hit reaction animations in msec
		HitReactionThreshold1 = 200.0	;// level 1 (light  damage) threshold trigger
	End
	
	Behavior = ProductionUpdate ProductionUpdateModuleTag
		GiveNoXP = Yes
		MaxQueueEntries = 1 ; only allow one queued upgrade at a time
	End

	;--------------------------------------------------------------------------------------------
	;//-------------------------Dain's Stubborn Pride--------------------------------------
	;--------------------------------------------------------------------------------------------
	Behavior = UnpauseSpecialPowerUpgrade ModuleTag_StubbornPrideUnpause
		SpecialPowerTemplate		= SpecialAbilityDainStubbornPride
		TriggeredBy					= Upgrade_DainStubbornPride
	End

	Behavior = SpecialPowerModule ModuleTag_StubbornPrideSpecialPower
		SpecialPowerTemplate		= SpecialAbilityDainStubbornPride
		UpdateModuleStartsAttack	= No
		StartsPaused				= Yes
	End	

	Behavior = AttributeModifierAuraUpdate ModuleTag_StubbornPrideUpdate
		StartsActive				= No
		BonusName					= DainStubbornPride
		TriggeredBy					= Upgrade_DainStubbornPride
		RefreshDelay				= 2000
		Range						= 200
		ObjectFilter				= ANY +INFANTRY +CAVALRY -STRUCTURE -BASE_FOUNDATION -HERO -DOZER ALLIES
	End	
	
	;--------------------------------------------------------------------------------------------
	;//-------------------------Dain's Leadership--------------------------------------
	;--------------------------------------------------------------------------------------------
	Behavior = UnpauseSpecialPowerUpgrade ModuleTag_DainLeadership
		SpecialPowerTemplate	= SpecialAbilityFakeLeadership
		TriggeredBy				= Upgrade_DainLeadership
	End
	
	Behavior = SpecialPowerModule ModuleTag_DainLeadershipUpdate   
		SpecialPowerTemplate		= SpecialAbilityFakeLeadership
		UpdateModuleStartsAttack	= No
		StartsPaused				= Yes
	End	

	Behavior = AttributeModifierAuraUpdate ModuleTag_Leadership
		StartsActive	= No ;If no, requires upgrade to turn on.
		BonusName		= GenericHeroLeadership
		TriggeredBy		= Upgrade_DainLeadership
		RefreshDelay	= 2000
		Range			= 200
		AntiCategory	= BUFF
		ObjectFilter	= GENERIC_BUFF_RECIPIENT_OBJECT_FILTER
	End	

	;--------------------------------------------------------------------------------------------
	;//-------------------------Dain's Mighty Rage: Mighty Rage--------------------------------------
	;--------------------------------------------------------------------------------------------
	
	Behavior = UnpauseSpecialPowerUpgrade ModuleTag_MightyRageStarter
		SpecialPowerTemplate			= SpecialAbilityDainMightyRage
		TriggeredBy						= Upgrade_DainMightyRage
		ObeyRechageOnTrigger		= Yes
	End
	Behavior = SpecialPowerModule ModuleTag_DainMightyRageDummy
		SpecialPowerTemplate			= SpecialAbilityDainMightyRage
		StartsPaused					= Yes
		UpdateModuleStartsAttack		= Yes
	End
	
	Behavior = ActivateModuleSpecialPower ModuleTag_CloseTheGap
		SpecialPowerTemplate			= SpecialAbilityDainMightyRage
		StartAbilityRange				= 200
		TriggerSpecialPower				= ModuleTag_MightyRageHeal		TARGETPOS
		TriggerSpecialPower				= ModuleTag_MightyRageBuff		TARGETPOS
		TriggerSpecialPower				= ModuleTag_MightyRageDebuff		TARGETPOS
		TriggerSpecialPower				= ModuleTag_MightyRageSelfBuff	TARGETPOS
	End

	Behavior = SpecialPowerModule ModuleTag_MightyRageSelfBuff
		SpecialPowerTemplate			= SpecialAbilityActivateeDummy
		AttributeModifier				= DainMightyRageSelfBuff
		AttributeModifierRange			= DAIN_MIGHTYRAGE_EFFECT_RADIUS
		AttributeModifierAffects	= NONE +DwarvenDain ;ALLIES
		AttributeModifierAffectsSelf 	= Yes
	End
	
	Behavior = PlayerHealSpecialPower ModuleTag_MightyRageHeal
		SpecialPowerTemplate			= SpecialAbilityActivateeDummy
		HealAmount						= 1.0
		HealAsPercent					= Yes
		HealAffects						= INFANTRY CAVALRY HERO DOZER MONSTER
		HealRadius						= DAIN_MIGHTYRAGE_EFFECT_RADIUS
		HealFX							= FX_SpellHealUnitHealBuff
		InitiateSound					= DainMightyRage
		TriggerFX						= FX_DainMightyRage02
	End

	Behavior = SpecialPowerModule ModuleTag_MightyRageBuff
		SpecialPowerTemplate			= SpecialAbilityActivateeDummy
		AttributeModifier				= DainMightyRageBuff
		AttributeModifierRange			= DAIN_MIGHTYRAGE_EFFECT_RADIUS
		AttributeModifierAffects		= GENERIC_BUFF_RECIPIENT_OBJECT_FILTER
	End

	Behavior = SpecialPowerModule ModuleTag_MightyRageDebuff
		SpecialPowerTemplate			= SpecialAbilityActivateeDummy
		AttributeModifier				= DainRageDeBuff
		AttributeModifierRange			= DAIN_MIGHTYRAGE_EFFECT_RADIUS
		AttributeModifierAffects		= GENERIC_BUFF_RECIPIENT_OBJECT_FILTER
		AntiCategory					= LEADERSHIP BUFF
	End

 	;-------------------------------------------------------------------------------------------------
	;//-------------------------Dain's 	Summon Royal Guard--------------------------------------------
	;-------------------------------------------------------------------------------------------------
	Behavior = UnpauseSpecialPowerUpgrade ModuleTag_DainSummonEnabler
		SpecialPowerTemplate = SpecialAbilityDainSummonRoyalGuard
		TriggeredBy = Upgrade_DainRoyalGuard
		ObeyRechageOnTrigger		= Yes
	End

	Behavior = OCLSpecialPower ModuleTag_OCLSpecialPower
		SpecialPowerTemplate	= SpecialAbilityDainSummonRoyalGuard
		OCL						= OCL_SpawnDwarvenEgg
		CreateLocation			= CREATE_AT_LOCATION
		StartsPaused			= Yes
		;SetModelCondition		= ModelConditionState:USER_1
		;SetModelConditionTime	= 8.1
	End

	;---------UNMOUNT WAGON------------------------------------------------------------------------
 	Behavior = SpecialPowerModule ModuleTag_EagleToggleStarter                      
 		SpecialPowerTemplate		= SpecialAbilityShapeshiftOne
 		UpdateModuleStartsAttack	= Yes
 		StartsPaused				= Yes
		;InitiateSound				= FellBeastVoiceMove
 	End

	Behavior = ToggleMountedSpecialAbilityUpdate ModuleTag_EagleToggle
 		SpecialPowerTemplate    = SpecialAbilityShapeshiftOne
 		MountedTemplate			= DwarvenDain 
 		SynchronizeTimerOnSpecialPower = SpecialAbilityDainSummonRoyalGuard SpecialAbilityDainMightyRage
 		UnpackTime              = 2000
 		PreparationTime         = 0			; none, cause we hop onto our mount in no time at all :)
 		PackTime                = 0 		; none, cause we hop onto our mount in no time at all :)
 		OpacityTarget			= .0		; How see-thru to be at peak of change
 		AwardXPForTriggering    = 0
 		IgnoreFacingCheck		= Yes
		;TriggerSound			= FellBeastVoiceMove
            UnpackingVariation		= 1
	End

      Behavior = UnpauseSpecialPowerUpgrade ModuleTag_UnpauseEagle
		SpecialPowerTemplate = SpecialAbilityShapeshiftOne
		TriggeredBy = Upgrade_ObjectLevel5
	End

	Behavior = ArmorUpgrade ArmorUpgradeModuleTag
		TriggeredBy = Upgrade_DwarvenMithrilMail
		;ArmorSetFlag			= PLAYER_UPGRADE
	    ;KillArmorUpgrade = Yes ;This cancels any previous armor upgrade.
	End
	
	Behavior = SubObjectsUpgrade Armor_Upgrade
		TriggeredBy		= Upgrade_DwarvenMithrilMail
		UpgradeTexture	= dwarf_a.tga 0 rudwarf_b.tga
		RecolorHouse	= Yes
		ExcludeSubobjects = Forged_Blade
	End
	
	Behavior = SubObjectsUpgrade Armor_Hearth
		TriggeredBy		= Upgrade_BattleWagonHearth
		ShowSubObjects	= dwarfHearth dwarfHearthFire
	End
	
	Behavior = SubObjectsUpgrade Banner_Upgrade
		TriggeredBy		= Upgrade_ObjectLevel5
		ShowSubObjects	= Banner_L
	End
	
	Behavior = StatusBitsUpgrade ModuleTag_ProductionLegality2
		TriggeredBy = Upgrade_DwarvenForgedBlades
	End
	
	Behavior = StatusBitsUpgrade ModuleTag_ProductionLegality3
		TriggeredBy = Upgrade_DwarvenMithrilMail
	End
	
	/////////////////////
	// AISpecialPowers
	/////////////////////
	
	Behavior = AISpecialPowerUpdate GondorFighterHordeStanceBattle
		CommandButtonName = Command_SetStanceBattle
		SpecialPowerAIType = AI_SPECIAL_POWER_STANCEBATTLE
	End

	Behavior = AISpecialPowerUpdate GondorFighterHordeStanceAggressive
		CommandButtonName = Command_SetStanceAggressive
		SpecialPowerAIType = AI_SPECIAL_POWER_STANCEAGGRESSIVE
	End

	Behavior = AISpecialPowerUpdate GondorFighterHordeHoldGround
		CommandButtonName = Command_SetStanceHoldGround
		SpecialPowerAIType = AI_SPECIAL_POWER_STANCEHOLDGROUND
	End

	
	Behavior = AISpecialPowerUpdate DwarfBattlewagonOilBarrels
		CommandButtonName = Command_SpecialAbilityOilBarrels
		SpecialPowerAIType = AI_SPECIAL_POWER_RANGED_AOE_ATTACK
	End

	FormationPreviewDecal 
        	Texture = FPBattleWagonDecal
        	Width = 96
        	Height = 96
    	End
	
	Geometry = Box
	GeometryMajorRadius = 30.0
	GeometryMinorRadius = 17.0
	GeometryHeight = 44.8
	GeometryOffset = X:5.0 Y:0.0 Z:0.0
	
	GeometryIsSmall = No
	DeadCollideSize = LARGE ; How big does the AOD consider this unit for damage fx & behavior.

	Shadow = SHADOW_VOLUME_NON_SELF_2; volumetric shadow that doesn't cast onto all objects using SHADOW_VOLUME_NON_SELF_1
	ShadowSizeX = 36; clamp the angle so shadow isn't as long.	
	
	
	; *** AUTO RESOLVE DATA *** 
	AutoResolveUnitType = AutoResolveUnit_Cavalry
	AutoResolveCombatChain = AutoResolve_CavalryCombatChain
	
	AutoResolveBody = AutoResolve_DwarvenBattleWagonBody

	AutoResolveArmor
		Armor = AutoResolve_DwarvenBattleWagonArmor
	End

	AutoResolveWeapon
		Weapon = AutoResolve_DwarvenBattleWagonWeapon
	End	
End
